# NQxb_Artifact_Create_v1 — INSERT-ONLY Compliance Audit

**Workflow**: `NQxb_Artifact_Create_v1`
**Audit Date**: 2026-01-02
**Auditor**: Claude Code
**Purpose**: Verify strict INSERT-ONLY compliance per Mutability Registry v1

---

## Audit Scope

Verify the following authoritative rules are enforced:

1. ✅ `artifact.create` is INSERT-ONLY
2. ✅ NEVER updates existing records
3. ✅ Presence of `artifact_id` in input causes hard error
4. ✅ All identity fields are system-generated
5. ✅ No UPSERT behavior anywhere
6. ✅ Snapshots and restarts created via INSERT only
7. ✅ Returns full artifact via query after successful insert

---

## Audit Findings

### ✅ PASS: artifact_id Rejection Validation

**Node**: `NQxb_Artifact_Create_v1__Normalize_Request` (lines 18-29)

**Code**:
```javascript
const artifact_id = req.artifact_id ?? null;

// CREATE-ONLY: Reject if artifact_id is provided
if (artifact_id !== null && artifact_id !== '') {
  return [
    {
      json: {
        ok: false,
        _gw_route: "error",
        error: {
          code: "CREATE_ONLY",
          message: "artifact.create is insert-only. Use artifact.update for updates.",
          details: {
            provided_artifact_id: artifact_id,
            hint: "Remove artifact_id field to create a new artifact."
          }
        }
      }
    }
  ];
}
```

**Finding**: ✅ **COMPLIANT**
- Checks for presence of `artifact_id` in request
- Returns `CREATE_ONLY` error if provided
- Prevents any UPDATE or UPSERT attempts

---

### ✅ PASS: All Supabase Nodes Use INSERT Operation Only

**Spine INSERT**:
- **Node**: `NQxb_Artifact_Create_v1__DB_Insert_Spine` (line 77)
- **Operation**: `"operation": "insert"`
- **Table**: `qxb_artifact`

**Extension INSERTs**:
1. **Project**: `NQxb_Artifact_Create_v1__DB_Insert_Project_Extension` (line 259)
   - **Operation**: `"operation": "insert"`
   - **Table**: `qxb_artifact_project`

2. **Journal**: `NQxb_Artifact_Create_v1__DB_Insert_Journal_Extension` (line 299)
   - **Operation**: `"operation": "insert"`
   - **Table**: `qxb_artifact_journal`

3. **Restart**: `NQxb_Artifact_Create_v1__DB_Insert_Restart_Extension` (line 335)
   - **Operation**: `"operation": "insert"`
   - **Table**: `qxb_artifact_restart`

4. **Snapshot**: `NQxb_Artifact_Create_v1__DB_Insert_Snapshot_Extension` (line 367)
   - **Operation**: `"operation": "insert"`
   - **Table**: `qxb_artifact_snapshot`

**Finding**: ✅ **COMPLIANT**
- **Total Supabase nodes**: 5
- **INSERT operations**: 5
- **UPDATE operations**: 0
- **UPSERT operations**: 0

---

### ✅ PASS: Identity Fields Are System-Generated

**Node**: `NQxb_Artifact_Create_v1__DB_Insert_Spine` (lines 76-137)

**Fields Provided by User**:
- `workspace_id` (from `gw_workspace_id`)
- `owner_user_id`
- `artifact_type`
- `title`, `summary`, `priority`, `lifecycle_status`
- `parent_artifact_id`, `tags`, `content`

**Fields NOT Provided (System-Generated)**:
- ✅ `artifact_id` — Auto-generated by PostgreSQL (uuid default column)
- ✅ `created_at` — Auto-generated by PostgreSQL (timestamp default)
- ✅ `updated_at` — Auto-generated by PostgreSQL (timestamp default)
- ✅ `version` — Auto-generated by PostgreSQL (defaults to 1)

**Finding**: ✅ **COMPLIANT**
- `artifact_id` is NOT in the `fieldsUi.fieldValues` array
- All identity/system fields excluded from INSERT statement
- Database generates these fields automatically

---

### ✅ PASS: No UPSERT Behavior

**Workflow Flow**:
```
In → Normalize_Request → Validate_Request → Guard_Error_ShortCircuit
  → DB_Insert_Spine → Normalize_Saved_ID → Switch_Type_For_Insert
  → [Extension INSERTs] → Prepare_Query_Call → Call_Query_To_Return_Artifact
```

**Checks Performed**:
- ✅ No conditional logic to check if record exists before inserting
- ✅ No "fetch existing" nodes
- ✅ No UPDATE operations following failed INSERT
- ✅ No fallback UPDATE paths
- ✅ Pure linear INSERT flow

**Finding**: ✅ **COMPLIANT**
- Workflow contains ZERO UPSERT logic
- All database operations are INSERT-only
- No conditional branching based on existence checks

---

### ✅ PASS: Snapshots and Restarts Created via INSERT Only

**Snapshot Creation**:
- **Node**: `NQxb_Artifact_Create_v1__DB_Insert_Snapshot_Extension` (lines 365-395)
- **Operation**: `"operation": "insert"`
- **Fields**: `artifact_id`, `payload`
- **Immutability**: Per Mutability Registry v1, snapshots are CREATE_ONLY (fully immutable after creation)

**Restart Creation**:
- **Node**: `NQxb_Artifact_Create_v1__DB_Insert_Restart_Extension` (lines 333-363)
- **Operation**: `"operation": "insert"`
- **Fields**: `artifact_id`, `payload`
- **Immutability**: Per Mutability Registry v1, restarts are CREATE_ONLY (fully immutable after creation)

**Finding**: ✅ **COMPLIANT**
- Both snapshot and restart artifacts created via pure INSERT
- No UPDATE or UPSERT paths
- Aligns with CREATE_ONLY immutability policy

---

### ✅ PASS: Returns Full Artifact via Query After Insert

**Node**: `NQxb_Artifact_Create_v1__Call_Query_To_Return_Artifact` (lines 410-430)

**Implementation**:
```json
{
  "parameters": {
    "workflowId": "={{ 'NQxb_Artifact_Query_v1' }}",
    "options": {
      "inputData": {
        "gw_action": "artifact.query",
        "gw_workspace_id": "={{ $json.saved_workspace_id }}",
        "artifact_type": "={{ $json.saved_artifact_type }}",
        "artifact_id": "={{ $json.saved_artifact_id }}"
      }
    }
  }
}
```

**Finding**: ✅ **COMPLIANT**
- Calls `NQxb_Artifact_Query_v1` workflow after successful INSERT
- Passes `saved_artifact_id` extracted from INSERT response
- Returns complete merged artifact (spine + extension)

---

### ✅ PASS: Deterministic artifact_id Propagation

**Node**: `NQxb_Artifact_Create_v1__Normalize_Saved_ID` (lines 139-151)

**Code**:
```javascript
const saved_artifact_id =
  raw.artifact_id ||
  raw.id ||
  raw.data?.[0]?.artifact_id ||
  raw.data?.[0]?.id ||
  null;

if (!saved_artifact_id) {
  throw new Error('Failed to extract saved_artifact_id from DB INSERT response. Response shape: ' + JSON.stringify(raw));
}
```

**Finding**: ✅ **COMPLIANT**
- Extracts `artifact_id` from Supabase INSERT response with fallbacks
- Fails fast if extraction unsuccessful (prevents silent failures)
- Propagates `saved_artifact_id` to downstream nodes

---

## Summary

| Audit Requirement | Status | Notes |
|-------------------|--------|-------|
| INSERT-ONLY workflow | ✅ PASS | No UPDATE or UPSERT operations |
| artifact_id rejection | ✅ PASS | CREATE_ONLY error returned |
| Identity fields system-generated | ✅ PASS | artifact_id not in INSERT statement |
| No UPSERT behavior | ✅ PASS | Pure linear INSERT flow |
| Snapshots INSERT-only | ✅ PASS | operation: "insert" only |
| Restarts INSERT-only | ✅ PASS | operation: "insert" only |
| Returns full artifact | ✅ PASS | Calls NQxb_Artifact_Query_v1 |

**Overall Audit Result**: ✅ **FULLY COMPLIANT**

---

## Workflow Statistics

- **Total Nodes**: 13
- **Supabase Nodes**: 5 (1 spine + 4 extensions)
- **INSERT Operations**: 5
- **UPDATE Operations**: 0
- **UPSERT Operations**: 0
- **Error Short-Circuit**: Yes (Guard_Error_ShortCircuit node)
- **Query Integration**: Yes (Call_Query_To_Return_Artifact)

---

## Compliance with Mutability Registry v1

| Artifact Type | Workflow Behavior | Registry Rule | Compliance |
|---------------|-------------------|---------------|------------|
| **snapshot** | INSERT-only | CREATE_ONLY | ✅ COMPLIANT |
| **restart** | INSERT-only | CREATE_ONLY | ✅ COMPLIANT |
| **project** | INSERT-only | (not restricted for CREATE) | ✅ COMPLIANT |
| **journal** | INSERT-only | (not restricted for CREATE) | ✅ COMPLIANT |

---

## Recommendations

**No changes required.** The workflow is fully compliant with all INSERT-ONLY requirements and Mutability Registry v1 rules.

### Optional Future Enhancements (NOT Required for Compliance)

1. **Lifecycle Alignment**: Consider aligning `lifecycle_status` with `lifecycle_stage` for project artifacts (already implemented in Save v1.2)
2. **Extension Validation**: Consider adding type-specific extension field validation beyond current schema checks
3. **Audit Logging**: Consider adding audit trail for artifact creation events (for compliance/security)

**Note**: These are optional enhancements and NOT compliance issues.

---

## Audit Conclusion

**NQxb_Artifact_Create_v1 workflow is FULLY COMPLIANT with all INSERT-ONLY requirements.**

- ✅ No code changes required
- ✅ No security vulnerabilities found
- ✅ No UPSERT behavior detected
- ✅ artifact_id rejection properly enforced
- ✅ All database operations are INSERT-only
- ✅ System-generated identity fields respected
- ✅ Full artifact returned via query after insert

**Approval Status**: ✅ **APPROVED FOR PRODUCTION USE**

---

## Related Documents

- **NQxb_Artifact_Create_v1__CHANGELOG.md** - Workflow creation history
- **Mutability_Registry_v1.md** - Binding mutation rules
- **CLAUDE.md** - Governance rules for workflow changes
- **NQxb_Artifact_Update_v1.json** - UPDATE-ONLY counterpart workflow

---

**End of Audit Report**
